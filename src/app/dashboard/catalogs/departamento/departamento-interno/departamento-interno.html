<div class="department-detail">
  <div class="department-detail__empty-state" *ngIf="!departamentoSeleccionado">
    <div class="empty-state">
      <i class="fas fa-building empty-state__icon"></i>
      <h3 class="empty-state__title">Selecciona un departamento</h3>
      <p class="empty-state__message">
        Elige un departamento de la lista para ver sus empleados y gestionarlos.
      </p>
    </div>
  </div>

  <div class="department-detail__content" *ngIf="departamentoSeleccionado">
    <header class="department-detail__header">
      <div class="department-detail__title-section">
        <h2 class="department-detail__title">
          {{ departamentoSeleccionado.nombreDepartamento }} / Empleados
        </h2>
        <p class="department-detail__subtitle">
          Visualiza y gestiona los empleados de este departamento.
        </p>
      </div>

      <div class="department-detail__search">
        <div class="search-box">
          <i class="fas fa-search search-box__icon"></i>
          <input
            type="text"
            class="search-box__input"
            [(ngModel)]="busqueda"
            (input)="filtrarEmpleados()"
            placeholder="Buscar empleado por nombre..."
          />
        </div>
      </div>

      <div class="department-detail__add-employee">
        <button
          type="button"
          class="btn-add-employee"
          (click)="abrirModalAgregarEmpleado()"
          aria-label="Agregar empleado"
        >
          <i class="fas fa-plus"></i> Crear
        </button>
      </div>
    </header>

    <div class="department-detail__employees" *ngIf="empleadosFiltrados.length > 0">
      <ng-container *ngFor="let grupo of empleadosAgrupados | keyvalue: sortByKey">
        <div class="employee-group">
          <h3 class="employee-group__letter">{{ grupo.key }}</h3>

          <div class="employee-cards">
            <div class="employee-card" *ngFor="let empleado of grupo.value">
              <div class="employee-card__info">
                <div class="employee-card__header">
                  <h4 class="employee-card__name">
                    {{ empleado.nombreEmpleado }} {{ empleado.apellidoPaternoEmpleado }} {{ empleado.apellidoMaternoEmpleado }}
                  </h4>
                  <span class="employee-card__position">
                    {{ empleado.puesto?.nombre || 'Sin puesto asignado' }}
                  </span>
                </div>
              </div>

              <div class="employee-card__actions">
                <button 
                  class="employee-card__menu-btn"
                  (click)="toggleMenu(empleado.id)"
                  [attr.aria-expanded]="menuEmpleadoAbiertoId === empleado.id"
                  aria-label="Opciones del empleado"
                >
                  <i class="fas fa-ellipsis-v"></i>
                </button>

                <div 
                  class="employee-card__menu" 
                  *ngIf="menuEmpleadoAbiertoId === empleado.id"
                  [class.employee-card__menu--active]="menuEmpleadoAbiertoId === empleado.id"
                >
                  <button 
                    class="employee-card__menu-item"
                    (click)="editarEmpleado(empleado)"
                  >
                    <i class="fas fa-edit"></i>
                    Editar
                  </button>
                  <button 
                    class="employee-card__menu-item"
                    (click)="cambiarDepartamento(empleado)"
                  >
                    <i class="fas fa-exchange-alt"></i>
                    Cambiar departamento
                  </button>
                  <button 
                    class="employee-card__menu-item employee-card__menu-item--danger"
                    (click)="eliminarEmpleado(empleado)"
                  >
                    <i class="fas fa-trash"></i>
                    Eliminar
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </ng-container>
    </div>

    <div class="department-detail__no-results" *ngIf="departamentoSeleccionado && empleadosFiltrados.length === 0">
      <div class="no-results">
        <i class="fas fa-search no-results__icon"></i>
        <h3 class="no-results__title">No se encontraron empleados</h3>
        <p class="no-results__message">
          No hay empleados que coincidan con tu búsqueda. Intenta con otros términos.
        </p>
      </div>
    </div>
  </div>

  <div class="modal-overlay" *ngIf="modalVisible" (click)="cerrarModal()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <app-empleado
        (cerrarModal)="cerrarModal()"
        (empleadoCreado)="onEmpleadoCreado($event)"
      ></app-empleado>
    </div>
  </div>

  <div class="modal-overlay" *ngIf="modalEditarVisible" (click)="cerrarModal()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <app-empleado
        [empleadoAEditar]="empleadoAEditar"
        (cerrarModal)="cerrarModal()"
        (empleadoEditado)="onEmpleadoEditado($event)"
      ></app-empleado>
    </div>
  </div>

  <div class="modal-overlay" *ngIf="modalCambiarDepartamentoVisible" (click)="cerrarModalCambioDepartamento()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">
          <i class="fas fa-exchange-alt"></i>
          Cambiar Departamento
        </h3>
        <button 
          class="modal-close-btn" 
          (click)="cerrarModalCambioDepartamento()"
          aria-label="Cerrar modal"
        >
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="modal-body">
        <div class="employee-info" *ngIf="empleadoACambiar">
          <h4>Empleado seleccionado:</h4>
          <div class="employee-card employee-card--selected">
            <div class="employee-card__info">
              <div class="employee-card__header">
                <h4 class="employee-card__name">
                  {{ empleadoACambiar.nombreEmpleado }} {{ empleadoACambiar.apellidoPaternoEmpleado }} {{ empleadoACambiar.apellidoMaternoEmpleado }}
                </h4>
                <span class="employee-card__position">
                  {{ empleadoACambiar.puesto.nombre || 'Sin puesto asignado' }}
                </span>
              </div>
            </div>
          </div>
        </div>

        <div class="department-selection">
          <label for="departamento-select" class="form-label">
            <i class="fas fa-building"></i>
            Seleccionar nuevo departamento:
          </label>
          
          <select 
            id="departamento-select"
            class="form-select"
            [(ngModel)]="departamentoSeleccionadoParaCambio"
          >
            <option [ngValue]="null">-- Selecciona un departamento --</option>
            <option 
              *ngFor="let dept of departamentosDisponibles" 
              [ngValue]="dept.id"
            >
              {{ dept.nombreDepartamento }}
            </option>
          </select>
        </div>
      </div>

      <div class="modal-footer">
        <button 
          type="button" 
          class="btn btn--secondary" 
          (click)="cerrarModalCambioDepartamento()"
          [disabled]="isMoviendoEmpleado"
        >
          Cancelar
        </button>
        
        <button 
          type="button" 
          class="btn btn--primary" 
          (click)="realizarCambioDepartamento()"
          [disabled]="!departamentoSeleccionadoParaCambio || isMoviendoEmpleado"
        >
          <span *ngIf="isMoviendoEmpleado">
            <i class="fas fa-spinner fa-spin"></i>
            Moviendo...
          </span>
          <span *ngIf="!isMoviendoEmpleado">
            <i class="fas fa-exchange-alt"></i>
            Cambiar Departamento
          </span>
        </button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" *ngIf="modalEliminarVisible" (click)="cerrarModalEliminar()">
    <div class="modal-container modal-container--danger" (click)="$event.stopPropagation()">
      
      <div class="modal-header modal-header--danger">
        <div class="modal-header-icon">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h3 class="modal-title">Confirmar Eliminación</h3>
        <button 
          type="button" 
          class="modal-close-btn" 
          (click)="cerrarModalEliminar()"
          [disabled]="isEliminandoEmpleado"
          aria-label="Cerrar modal"
        >
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="modal-body">
        <div class="modal-message">
          <p class="modal-message-text">
            ¿Está seguro que desea eliminar al empleado?
          </p>
          
          <div class="modal-employee-info" *ngIf="empleadoAEliminar">
            <div class="employee-info">
              <div class="employee-info-avatar">
                <i class="fas fa-user"></i>
              </div>
              <div class="employee-info-details">
                <h4 class="employee-info-name">
                  {{ empleadoAEliminar.nombreEmpleado }} 
                  {{ empleadoAEliminar.apellidoPaternoEmpleado }} 
                  {{ empleadoAEliminar.apellidoMaternoEmpleado }}
                </h4>
                <p class="employee-info-code">
                  Código: {{ empleadoAEliminar.codigoEmpleado }}
                </p>
                <p class="employee-info-position">
                  {{ empleadoAEliminar.puesto.nombre || 'Sin puesto asignado' }}
                </p>
              </div>
            </div>
          </div>
          
          <div class="modal-warning">
            <i class="fas fa-exclamation-circle"></i>
            <span>Esta acción no se puede deshacer</span>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button 
          type="button" 
          class="btn btn--secondary"
          (click)="cerrarModalEliminar()"
          [disabled]="isEliminandoEmpleado"
        >
          Cancelar
        </button>
        
        <button 
          type="button" 
          class="btn btn--danger"
          (click)="confirmarEliminacion()"
          [disabled]="isEliminandoEmpleado"
        >
          <span *ngIf="!isEliminandoEmpleado">
            <i class="fas fa-trash"></i>
            Eliminar Empleado
          </span>
          <span *ngIf="isEliminandoEmpleado">
            <i class="fas fa-spinner fa-spin"></i>
            Eliminando...
          </span>
        </button>
      </div>
      
    </div>
  </div>
</div>
